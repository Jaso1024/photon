# ARM64-compatible Sunshine container - MINIMAL version
FROM ubuntu:22.04

# Install dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    git \
    libssl-dev \
    libboost-filesystem-dev \
    libboost-log-dev \
    libboost-program-options-dev \
    libboost-thread-dev \
    libcurl4-openssl-dev \
    libopus-dev \
    libpulse-dev \
    libavcodec-dev \
    libavutil-dev \
    libavformat-dev \
    && rm -rf /var/lib/apt/lists/*

# Clone minimal required branches
RUN git clone --depth 1 https://github.com/LizardByte/Sunshine.git /sunshine && \
    cd /sunshine && \
    git submodule update --init --depth 1 -- \
        third-party/moonlight-common-c \
        third-party/Simple-Web-Server \
        third-party/nanors && \
    cd third-party/moonlight-common-c && \
    git submodule update --init --depth 1 -- enet

# Create user
RUN useradd -m -s /bin/bash sunshine && \
    mkdir -p /home/sunshine/.config/sunshine && \
    chown -R sunshine:sunshine /home/sunshine

# Build minimal version
WORKDIR /sunshine
RUN mkdir -p build && cd build && \
    cmake -DCMAKE_BUILD_TYPE=Release \
          -DSUNSHINE_ENABLE_WAYLAND=OFF \
          -DSUNSHINE_ENABLE_X11=OFF \
          -DSUNSHINE_ENABLE_DRM=OFF \
          -DSUNSHINE_ENABLE_CUDA=OFF \
          -DSUNSHINE_ENABLE_NVENC=OFF \
          -DSUNSHINE_ENABLE_NVFBC=OFF \
          -DSUNSHINE_ENABLE_VAAPI=OFF \
          -DSUNSHINE_STREAMING_ADAPTER=0 \
          -DSUNSHINE_ASSETS_DIR=/sunshine/assets \
          .. && \
    make -j$(nproc) && \
    cp sunshine /usr/local/bin/ && \
    chmod +x /usr/local/bin/sunshine

# Create assets dir
RUN mkdir -p /sunshine/assets && \
    cp -r /sunshine/src_assets/common/assets/* /sunshine/assets/ || true

# Set up configuration
USER sunshine
WORKDIR /home/sunshine

# Configure Sunshine - disable updates, telemetry, etc.
RUN echo "origin_web_ui_allowed = false" >> ~/.config/sunshine/sunshine.conf && \
    echo "upnp = false" >> ~/.config/sunshine/sunshine.conf && \
    echo "autoUpdateCheck = false" >> ~/.config/sunshine/sunshine.conf && \
    echo "external_ip = \"\"" >> ~/.config/sunshine/sunshine.conf && \
    echo "cmd_args = []" >> ~/.config/sunshine/sunshine.conf

# Start script
RUN echo '#!/bin/bash\n\
echo "Sunshine ARM64 Minimal Container"\n\
echo "Starting Sunshine..."\n\
/usr/local/bin/sunshine --sunshine.conf /home/sunshine/.config/sunshine/sunshine.conf\n\
' > /home/sunshine/start.sh && \
    chmod +x /home/sunshine/start.sh

# Expose ports
EXPOSE 47984/tcp 47989/tcp 47990/tcp 48010/tcp

CMD ["/home/sunshine/start.sh"]